<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="A web-based 3D CAD application for online model design and editing" />
        <meta name="description" content="‰∏ÄÊ¨æÂü∫‰∫éÁΩëÈ°µÁöÑÂú®Á∫øÊ®°ÂûãËÆæËÆ°‰∏éÁºñËæë 3D CAD Â∫îÁî®Á®ãÂ∫è" />
        <meta name="keywords" content="Web CAD, WebAssembly, WASM, Three.js, OCCT, Opencascade, 3D CAD, Âú®Á∫ø CAD, Âú®Á∫øÂª∫Ê®°" />
        <meta name="author" content="‰ªôÈòÅ" />
        <title>Chili3D - Web-based 3D CAD application</title>
        <link rel="icon" href="favicon.svg">
        <link rel="stylesheet" type="text/css" href="index.css" />
        <script type="text/javascript">
            (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "k1qrtibhcl");
        </script>
    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <!-- Viewer Mode Script -->
        <script src="viewer-mode.js"></script>
        
        <!-- Theme & Navigation Forcing + Model Loading Script -->
        <script>
            (function() {
                'use strict';
                
                console.log('üöÄ Chili3D Custom Loader v2.0');
                
                // Get parameters from URL
                const urlParams = new URLSearchParams(window.location.search);
                const themeFromUrl = urlParams.get('theme') || 'light';
                const modelUrl = urlParams.get('url'); // Get model URL but DON'T auto-load yet
                const navigationMode = 'solidworks';
                
                console.log('üé® Target theme:', themeFromUrl);
                console.log('üéÆ Target navigation:', navigationMode);
                console.log('üì¶ Model URL:', modelUrl || 'Will wait for postMessage');
                
                let modelLoadedOnce = false; // Prevent double loading
                
                // Apply theme and navigation to DOM immediately
                function applyThemeToDOM() {
                    document.documentElement.setAttribute('data-theme', themeFromUrl);
                    document.body.setAttribute('data-theme', themeFromUrl);
                    
                    if (themeFromUrl === 'dark') {
                        document.documentElement.classList.add('dark');
                        document.body.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.body.classList.remove('dark');
                    }
                    console.log('‚úÖ Applied theme to DOM');
                }
                
                // Apply immediately
                applyThemeToDOM();
                
                // Wait for Chili3D app to be ready
                async function waitForApp() {
                    let attempts = 0;
                    while (!window.app && attempts < 100) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    return window.app ? true : false;
                }
                
                // Apply settings via Chili3D's UI after it loads
                async function applySettingsViaUI() {
                    console.log('‚è≥ Waiting for Chili3D UI...');
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const allSelects = document.querySelectorAll('select');
                    console.log(`Found ${allSelects.length} select elements`);
                    
                    // Set theme
                    for (let select of allSelects) {
                        const options = Array.from(select.options);
                        const themeOption = options.find(opt => 
                            opt.value === themeFromUrl || 
                            opt.textContent.toLowerCase().includes(themeFromUrl.toLowerCase())
                        );
                        if (themeOption) {
                            select.value = themeOption.value;
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                            console.log('‚úÖ Theme dropdown set to:', themeFromUrl);
                            break;
                        }
                    }
                    
                    // Set navigation to SolidWorks
                    for (let select of allSelects) {
                        const options = Array.from(select.options);
                        const swOption = options.find(opt => 
                            opt.textContent.toLowerCase().includes('solidworks')
                        );
                        if (swOption) {
                            select.value = swOption.value;
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                            console.log('‚úÖ Navigation set to: SolidWorks');
                            break;
                        }
                    }
                    
                    // Apply theme to DOM again after UI loads
                    applyThemeToDOM();
                }
                
                // Load model function (only call once!)
                async function loadModel(url) {
                    if (modelLoadedOnce) {
                        console.warn('‚ö†Ô∏è Model already loaded, skipping duplicate load');
                        return;
                    }
                    
                    modelLoadedOnce = true;
                    console.log('üì• Loading model:', url);
                    
                    try {
                        const appReady = await waitForApp();
                        if (!appReady) {
                            throw new Error('Chili3D app not ready');
                        }
                        
                        console.log('‚úÖ Chili3D app ready');
                        
                        // Apply settings BEFORE loading model
                        await applySettingsViaUI();
                        
                        // Now load the model
                        console.log('üì• Calling loadFileFromUrl...');
                        await window.app.loadFileFromUrl(url);
                        
                        console.log('‚úÖ Model loaded successfully');
                        
                        // Notify parent
                        if (window.parent !== window) {
                            window.parent.postMessage({ type: 'model-loaded' }, '*');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error loading model:', error);
                        
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'load-error',
                                error: error.message
                            }, '*');
                        }
                    }
                }
                
                // Listen for postMessage commands
                window.addEventListener('message', async (event) => {
                    console.log('üì® Received message:', event.data);
                    
                    if (event.data.type === 'load-from-url' && event.data.url) {
                        console.log('üì¶ Load command via postMessage');
                        await loadModel(event.data.url);
                    }
                });
                
                // If URL parameter is provided, load it automatically
                // (This handles direct navigation to Chili3D)
                window.addEventListener('load', async () => {
                    console.log('üåê Page loaded');
                    
                    // Notify parent we're ready
                    setTimeout(() => {
                        if (window.parent !== window) {
                            console.log('üì¢ Notifying parent: Chili3D ready');
                            window.parent.postMessage({ type: 'chili3d-ready' }, '*');
                        }
                    }, 3000);
                    
                    // If there's a URL parameter and we're NOT in an iframe, load it
                    if (modelUrl && window.parent === window) {
                        console.log('üîó Direct access with URL, loading model...');
                        await loadModel(modelUrl);
                    } else if (modelUrl && window.parent !== window) {
                        console.log('üì≠ In iframe with URL, waiting for postMessage...');
                        // Don't auto-load, wait for postMessage to avoid double loading
                    } else {
                        console.log('‚è∏Ô∏è No URL parameter, waiting for commands');
                    }
                });
                
            })();
        </script>
    </body>
</html>

<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="A web-based 3D CAD application for online model design and editing" />
        <meta name="description" content="ä¸€æ¬¾åŸºäºŽç½‘é¡µçš„åœ¨çº¿æ¨¡åž‹è®¾è®¡ä¸Žç¼–è¾‘ 3D CAD åº”ç”¨ç¨‹åº" />
        <meta name="keywords" content="Web CAD, WebAssembly, WASM, Three.js, OCCT, Opencascade, 3D CAD, åœ¨çº¿ CAD, åœ¨çº¿å»ºæ¨¡" />
        <meta name="author" content="ä»™é˜" />
        <title>Chili3D - Web-based 3D CAD application</title>
        <link rel="icon" href="favicon.svg">
        <link rel="stylesheet" type="text/css" href="index.css" />
        <script type="text/javascript">
            (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "k1qrtibhcl");
        </script>
    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <!-- Viewer Mode Script -->
        <script src="viewer-mode.js"></script>
        
        <!-- URL-based file loading script - FIXED VERSION -->
        <script>
            (function() {
                'use strict';
                
                console.log('ðŸš€ Chili3D URL loader initialized (FIXED VERSION)');
                
                // Get theme and navigation from URL
                const urlParams = new URLSearchParams(window.location.search);
                const themeFromUrl = urlParams.get('theme') || 'light';
                const navigationMode = 'solidworks'; // Always use SolidWorks
                
                console.log('Target theme:', themeFromUrl);
                console.log('Target navigation:', navigationMode);
                
                // STEP 1: Clear and rewrite IndexedDB preferences IMMEDIATELY
                function forcePreferencesToStorage() {
                    // Delete the entire database to start fresh
                    const deleteRequest = indexedDB.deleteDatabase('chili3d-db');
                    
                    deleteRequest.onsuccess = () => {
                        console.log('âœ… Cleared old Chili3D database');
                        
                        // Now create new database with our preferences
                        setTimeout(() => {
                            const openRequest = indexedDB.open('chili3d-db', 1);
                            
                            openRequest.onupgradeneeded = (event) => {
                                const db = event.target.result;
                                if (!db.objectStoreNames.contains('preferences')) {
                                    db.createObjectStore('preferences');
                                }
                            };
                            
                            openRequest.onsuccess = (event) => {
                                const db = event.target.result;
                                const tx = db.transaction(['preferences'], 'readwrite');
                                const store = tx.objectStore('preferences');
                                
                                // Write theme
                                store.put(themeFromUrl, 'theme');
                                store.put(themeFromUrl, 'appearance.theme');
                                
                                // Write navigation
                                store.put(navigationMode, 'navigation');
                                store.put(navigationMode, 'navigation.mode');
                                
                                tx.oncomplete = () => {
                                    console.log('âœ… Wrote preferences to fresh database');
                                };
                                
                                db.close();
                            };
                        }, 100);
                    };
                    
                    deleteRequest.onerror = () => {
                        console.warn('âš ï¸ Could not delete database, trying to overwrite');
                        
                        // If delete fails, just overwrite
                        const openRequest = indexedDB.open('chili3d-db');
                        openRequest.onsuccess = (event) => {
                            const db = event.target.result;
                            if (db.objectStoreNames.contains('preferences')) {
                                const tx = db.transaction(['preferences'], 'readwrite');
                                const store = tx.objectStore('preferences');
                                
                                // Overwrite theme
                                store.put(themeFromUrl, 'theme');
                                store.put(themeFromUrl, 'appearance.theme');
                                
                                // Overwrite navigation
                                store.put(navigationMode, 'navigation');
                                store.put(navigationMode, 'navigation.mode');
                                
                                tx.oncomplete = () => {
                                    console.log('âœ… Overwrote preferences in existing database');
                                };
                            }
                            db.close();
                        };
                    };
                }
                
                // Run immediately
                forcePreferencesToStorage();
                
                // STEP 2: Listen for messages from parent window
                window.addEventListener('message', async (event) => {
                    console.log('ðŸ“¨ Received message:', event.data);
                    
                    if (event.data.type === 'load-from-url' && event.data.url) {
                        console.log('ðŸ“¦ Load from URL command received:', event.data.url);
                        
                        try {
                            // Wait for app to be ready
                            let attempts = 0;
                            while (!window.app && attempts < 50) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                attempts++;
                            }
                            
                            if (!window.app) {
                                throw new Error('window.app not found after waiting');
                            }
                            
                            console.log('âœ… window.app is ready');
                            
                            // Apply theme and navigation via UI (as backup)
                            try {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                const allSelects = document.querySelectorAll('select');
                                
                                // Set theme
                                for (let select of allSelects) {
                                    const options = Array.from(select.options);
                                    const themeOption = options.find(opt => 
                                        opt.value === themeFromUrl || 
                                        opt.textContent.toLowerCase() === themeFromUrl.toLowerCase()
                                    );
                                    if (themeOption) {
                                        select.value = themeOption.value;
                                        select.dispatchEvent(new Event('change', { bubbles: true }));
                                        console.log('âœ“ Theme UI updated to', themeFromUrl);
                                        break;
                                    }
                                }
                                
                                // Set navigation
                                for (let select of allSelects) {
                                    const options = Array.from(select.options);
                                    const solidworksOption = options.find(opt => 
                                        opt.textContent === 'Solidworks'
                                    );
                                    if (solidworksOption) {
                                        select.value = solidworksOption.value;
                                        select.dispatchEvent(new Event('change', { bubbles: true }));
                                        console.log('âœ“ Navigation UI set to Solidworks');
                                        break;
                                    }
                                }
                                
                            } catch (err) {
                                console.warn('Could not update UI (not critical):', err);
                            }
                            
                            // Load the model
                            console.log('ðŸ“¥ Loading model...');
                            await window.app.loadFileFromUrl(event.data.url);
                            
                            console.log('âœ… Model loaded successfully');
                            
                            // Wait for view to be ready
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            // Notify parent
                            if (window.parent !== window) {
                                window.parent.postMessage({ type: 'model-loaded' }, '*');
                            }
                            
                        } catch (error) {
                            console.error('âŒ Failed to load:', error);
                            
                            if (window.parent !== window) {
                                window.parent.postMessage({
                                    type: 'load-error',
                                    error: error.message
                                }, '*');
                            }
                        }
                    }
                });
                
                // STEP 3: Notify parent that we're ready
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        if (window.parent !== window) {
                            console.log('ðŸ“¢ Notifying parent that Chili3D is ready');
                            window.parent.postMessage({ type: 'chili3d-ready' }, '*');
                        }
                    }, 4000);
                });
                
            })();
        </script>
    </body>
</html>
